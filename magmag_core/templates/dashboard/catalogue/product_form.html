{% load i18n %}
<script>
    //@ sourceURL={{ current_path }}.js
    Ext.onReady(init_page);
    function init_page()
    {
        var categories_store = new Ext.data.TreeStore({
            storeId: 'productCategoryTreeStore',
            model: 'Category',
            //autoLoad: true,
            proxy: {
                type: 'ajax',
                url: '{% url "magmag:dashboard:categories" "json" %}',
                reader: {
                    type: 'json',
                    root: 'data',
                    totalProperty: 'total'
                }
            }
        });

        var productItems_store = new Ext.data.JsonStore({
            storeId: 'product{0}'+ '{% if product.id %} {{ product.id }} {% else %} 0 {% endif %})'+ 'ItemsStore',
            model: 'ProductItems',
            proxy: {
                type: 'ajax',
                url:{% if product.id %} '{% url "magmag:dashboard:product_items"  pk=product.id content_type="json" %}' {% else %}
                '{% url "magmag:dashboard:product_items"  pk=0 content_type="json" %}' {% endif %},
                reader: {
                    type: 'json',
                    root: 'data',
                    totalProperty: 'total'
                }
            }

        });

        categories_store.load();
        var tab = Ext.getCmp('{{ current_path }}');
        if (tab)
        {
            var container = new Ext.panel.Panel( {
                layout: 'fit',
                //title: '{% trans "Product" %}',
                id: '{{ current_path  }}_container',
                items: [
                    {
                        xtype:'panel',
                        layout: 'border',
                        items:[
                            {
                                xtype:'form',
                                id: '{{ current_path  }}_productMainForm',
                                title: '{% trans 'Main info' %}',
                                region:'center',
                                layout: {
                                        type: 'hbox',
                                        align: 'stretch'
                                },
                                border:true,
                                items:[
                                    {
                                        xtype: 'panel',
                                        flex: 3,
                                        layout:'form',
                                        cls:'pnlFormDetail',
                                        items:[
                                            {
                                                xtype: 'hidden',
                                                id:'{{ current_path  }}_hdnId',
                                                value: {% if product.id %} {{ product.id }} {% else %} 0 {% endif %},
                                                name: 'id'
                                            },{
                                                xtype: 'textfield',
                                                id:'{{ current_path  }}_txtName',
                                                fieldLabel: '{% trans 'Name' %}',
                                                name: 'name',
                                                value: '{{ product.name }}',
                                                allowBlank: false
                                            },{
                                                xtype: 'textfield',
                                                id:'{{ current_path  }}_txtArticle',
                                                fieldLabel: '{% trans 'Article' %}',
                                                name: 'article',
                                                value: '{{ product.article }}',
                                                allowBlank: false
                                            },Ext.create('Ext.ux.TreePicker', {
                                                store: categories_store,
                                                displayField: 'name',
                                                valueField: 'id',
                                                id:'{{ current_path  }}_cmbCategory',
                                                name: 'category',
                                                fieldLabel: '{% trans "Category" %}',
                                                allowBlank: false,
                                                value: {% if product.category %}{{ product.category.id }}{% else %}''{% endif %}
                                            }),{
                                                xtype: 'textfield',
                                                id:'{{ current_path  }}_txtSlug',
                                                fieldLabel: '{% trans 'Slug' %}',
                                                name: 'slug',
                                                value: '{{ product.slug }}',
                                                allowBlank: false
                                            },{
                                                xtype: 'textareafield',
                                                id:'{{ current_path  }}_txtDescription',
                                                fieldLabel: '{% trans 'Description' %}',
                                                name: 'description',
                                                value: '{{ product.descr }}'
                                            }
                                        ]
                                    },
                                    {
                                        xtype: 'panel',
                                        flex:2,
                                        cls:'pnlFormDetail',
                                        items:[
                                            {
                                                xtype: 'filefield',
                                                name: 'image',
                                                id: '{{ current_path  }}_ffImage',
                                                fieldLabel: '{% trans "Image" %}',
                                                buttonText: '{% trans "Select" %}...',
                                                labelWidth: 50,
                                                width:270,
                                                icon: '{{ STATIC_URL }}magmag_core/img/ext_icons/image_add.png',
                                                listeners: {
                                                    change: function(uploader, value, eOpts) {
                                                        var container = Ext.getCmp('{{ current_path  }}_pnlImagePreview');
                                                        if (container){
                                                            container.removeAll(true);
                                                            readImages(uploader.fileInputEl.dom, container);
                                                        }
                                                    }
                                                },
                                                value: {% if product.image %} '{{ product.image.url }}' {% else %} '' {% endif %}
                                            },
                                            {
                                                xtype: 'panel',
                                                collapsible: false,
                                                id:'{{ current_path  }}_pnlImagePreview',
                                                items:[
                                                    {
                                                        xtype:'image',
                                                        src: {% if product.image %} '{{ product.image.url }}' {% else %} '' {% endif %},
                                                        height:150
                                                    }
                                                ]
                                            }
                                        ]
                                    }
                                ]

                            },
                            {
                                xtype: 'panel',
                                id:'{{ current_path  }}_productImages',
                                region: 'south',
                                title:'{% trans 'Images' %}',
                                border: true,
                                height: '60%'


                            },
                            {
                                xtype: 'panel',
                                region: 'east',
                                width: '40%',
                                layout: 'fit',
                                id: '{{ current_path }}_productItems',
                                title: '{% trans 'Product items' %}',
                                border: true,
                                items:[
                                    {
                                        xtype:'grid',
                                        layout: 'fit',
                                        store: productItems_store,
                                        multiSelect: false,
                                        autoScroll: true,
                                        cls: 'dashboard-grid',
                                        columns: [
                                            {
                                                text: '{% trans "Name" %}',
                                                flex: 2,
                                                sortable: true,
                                                dataIndex: 'id'

                                            }
                                        ],
                                        plugins: [{
                                            ptype: 'rowexpander',
                                            rowBodyTpl : [
                                                '<p><b>Company:</b> {id}</p><br>'
                                            ]
                                        }],
                                        bbar:{
                                            xtype: 'pagingtoolbar',
                                            store: productItems_store,
                                            displayInfo: true
                                        }
                                    }

                                ]
                            }

                        ],
                        buttons:[
                            {
                                text: '{% trans 'Save' %}',
                                handler: function(){
                                    updateProduct(Ext.getCmp('{{ current_path  }}_productMainForm'));
                                }

                            },
                            {
                                text: '{% trans 'Cancel' %}',
                                handler: function(){

                                }
                            }
                        ]
                    }

                ]
            });
            tab.add(container);
        }
    }

//////handler
function updateProduct(form)
    {
        if(form)
        {
            form.getForm().submit({
                clientValidation: true,
                url: '{{ current_path }}',
                method: 'POST',
                params: {
                    action: 'update',
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(form, action) {
                    var tab = Ext.getCmp('{{ current_path }}');
                    if (tab)
                    {
                        tab.ownerCt.remove(tab.id);
                    }
                },
                failure: function(form, action) {
                    if (action.failureType == 'server')
                        alert('fail');
                }
            });
        }
        else
            alert('Save fail');
    }
</script>